## MySQL의 스토리지 엔진


![storage](https://github.com/Pearl-K/database_study/blob/main/chapter5/source/image/storage.png)
- MySQL에서 실제 Data를 디스크 스토리지에 저장하거나 읽어오는 부분을 담당한다.
- 그림 처럼 스토리지 엔진을 플러그인 방식으로 사용할 수 있는 구조를 가지기 때문에 필요에 따라 원하는 스토리지 엔진을 구성하여 사용할 수 있다.
- show [storage] engines 명령을 통해 스토리지 엔진 목록을 확인 가능하고, 테이블이 사용할 스토리지 엔진을 지정해줄 수 있다.



## InnoDB
- MySQL 8.0의 기본 스토리지 엔진 (가장 보편적으로 많이 사용함)
- DML 작업은 ACID 모델을 따르며, COMMIT & ROLLBACK 및 복구 기능을 갖춘 트랜잭션으로 데이터를 보호한다.
- Buffer Pool의 존재가 핵심 특징, 디스크 상의 Data 파일이나 인덱스 정보를 메모리에 캐시해두는 공간으로, 변경된 Data를 모아서 처리해주기 때문에 DISK I/O 횟수를 줄일 수 있다.


### Buffer Pool
- 디스크의 데이터 파일이나 인덱스 정보를 메모리에 캐시해 두는 공간
- 변경된 데이터를 모아서 처리하기 때문에 디스크 Random Access를 줄일 수 있다.

  
![list of buffer blocks](https://github.com/Pearl-K/database_study/blob/main/chapter5/source/image/bufferblocks.png)


#### InnoDB 스토리지 엔진은 Buffer Pool 관리를 위해서 Free 리스트, LRU(Least Recently Used) 리스트, Flush  리스트 3개의 자료 구조로 관리한다.
- Free List
  - 버퍼 풀에서 실제 사용자 데이터로 채워 지지 않은 비어있는 페이지 목록
  - 사용자의 쿼리가 새롭게 디스크 데이터 페이지를 읽어와야 할 때 사용한다.
  - 이 리스트가 비어있으면 LRU 리스트에서 페이지를 제거하여 공간을 확보한다.
- LRU List
  - 내부적으로 MRU, LRU로 관리되며 오래 지날 수록 LRU의 tail 부분으로 이동되어 버퍼 풀에서 제거된다. (+@ LRU 알고리즘으로 처리)
  - 페이지가 처음 버퍼 풀에 로드 되면 여기에 추가된다.
  - 디스크로부터 한 번 읽어온 페이지를 최대한 오래 버퍼 풀에 유지하여 디스크 읽기를 최소화하려는 목적이다.
- Flush List
  - 디스크로 동기화되지 않은 데이터를 가진 페이지 (변경된 페이지, 더티 페이지) 들이 저장되는 리스트이다.
  - 이 리스트를 통해 주기적으로 디스크에 데이터를 기록(flush) 하여 데이터 일관성을 유지한다.


### 버퍼 풀 페이지 종류
클린페이지 : 디스크에서 읽은 상태로 전혀 변경되지 않은 상태
더티페이지 : SELCT를 제외한 DML이 일어나 변경된 데이터를 가진 상태


### InnoDB에서 디스크에 데이터 쓰는 방법 3가지
1. Single Page Flush
- 사용자의 요청에 의해 발생하는 단일 페이지 쓰기 작업
- 이 방법은 주로 버퍼 풀에서 다른 데이터를 저장하기 위해 현재 페이지를 교체할 때 사용된다.
- 사용 시점: 즉시 필요한 경우에, 페이지가 교체 대상(victim)으로 선택되었을 때 사용된다.


2. LRU tail flush
- 주로 백그라운드 프로세스에 의해 비동기적으로 수행되는 쓰기 작업
- 주로 사용되지 않는 cold 페이지를 버퍼 풀에서 제거하기 위해 사용된다.
- 사용 시점: 버퍼 풀의 공간을 확보하기 위해 LRU 리스트의 끝부분에 있는 페이지를 디스크에 기록하고 버퍼에서 제거할 때 사용된다.


3. Checkpointing
- DB 복구를 위해 백그라운드 프로세스가 비동기적으로 수행하는 쓰기 작업
- InnoDB는 주기적으로 체크포인트를 생성하여, 특정 시점까지의 데이터 변경 사항을 모두 디스크에 기록한다.
- 이를 통해 시스템 장애 시 체크포인트 이후의 데이터만 복구하면 되므로, DB의 빠르고 안전한 복구가 가능하다.
- 사용 시점: 주기적으로 or 시스템 종료 시점에서 DB의 일관성을 유지하기 위해 사용된다.



#### MySQL 의 비정상 종료가 일어난 경우 InnoDB 스토리지 엔진의 데이터 파일은 두 가지 종류의 일관되지 않은 데이터를 가질 수 있고 각각 다르게 해결한다.
1. Commit 됐지만 데이터 파일에 기록되지 않은 데이터 : Redo log
2. Rollback 됐지만 데이터 파일에 이미 기록된 데이터 : Redo log + Undo log(변경되기 전 데이터를 알아야 하므로)





Ref.
- Real MySQL 8.0
- [InnoDB Buffer pool과 redo/undo](https://kominjae.tistory.com/168)
- 명규오빠가 보내준 수업자료
