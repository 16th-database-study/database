## MVCC(Multi-Version Concurrency Control, 다중 버전 동시성 제어)

### 1. MVCC
MVCC는 동시 접근을 허용하는 데이터베이스에서 동시성을 제어하기 위해 사용하는 방법 중 하나이다.
MVCC는 원본의 데이터와 변경중인 데이터를 동시에 유지하는 방식으로, 원본 데이터에 대한 Snapshot을 이용하여 데이터의 동시성을 제어한다.


#### 특징
- 일반적인 RDBMS보다 매우 빠르게 작동 (잠금을 필요로하지 않기 때문에)
- 사용하지 않는 데이터가 계속 쌓이게 되므로 데이터 정리 시스템 필요
- 데이터 버전이 충돌하면 애플리케이션 영역에서 이 문제를 해결해야 함


### MVCC에서의 스냅샷 읽기(Snapshot Read)
- 스냅샷 읽기는 MVCC(Multi-Version Concurrency Control)에서 중요한 개념이다.
- 트랜잭션이 시작될 때의 데이터베이스 상태를 스냅샷으로 저장하여 그 시점의 일관된 데이터를 읽을 수 있도록 하는 방식
- 이를 통해 여러 트랜잭션이 동시에 실행되더라도 데이터 일관성이 유지되며, 읽기 작업이 다른 트랜잭션의 쓰기 작업에 의해 방해받지 않는다.


1. 트랜잭션 격리 수준과 스냅샷 읽기
- Repeatable Read
  - 이 격리 수준에서는 트랜잭션이 시작된 시점의 스냅샷이 유지된다.
  - 동일한 트랜잭션 내에서 반복적으로 같은 데이터를 읽을 때, 트랜잭션이 시작된 시점의 데이터와 동일한 결과를 보장한다.
- Read Committed
  - 트랜잭션이 커밋될 때마다 새로운 스냅샷을 사용하여 데이터를 읽는다.
  - 따라서 트랜잭션 내에서 반복해서 읽기를 수행하면 최신의 커밋된 데이터를 볼 수 있다.


2. Undo 로그와 스냅샷 읽기
- 스냅샷 읽기는 Undo 로그를 활용하여 구현된다.
- 트랜잭션이 스냅샷을 생성할 때, 다른 트랜잭션이 데이터를 수정하고 커밋했더라도 Undo 로그를 통해 해당 데이터의 이전 버전을 읽어와 스냅샷 일관성을 유지한다.
- 이를 통해 데이터의 여러 버전이 동시에 존재할 수 있게 된다.


3. 가시성(Visibility) 판단
- InnoDB는 트랜잭션의 ID(Transaction ID)와 타임스탬프를 이용하여 어떤 데이터 버전이 특정 트랜잭션에 대해 가시성을 가지는지 판단한다.
- 예를 들어, 특정 트랜잭션이 커밋된 시점보다 이전에 생성된 데이터는 현재 트랜잭션에 가시적이게 된다.
- 가시성 판단을 통해 MVCC는 트랜잭션 간의 격리성을 유지하며 데이터의 일관된 읽기를 보장한다.



***


#### MySQL에서의 MVCC : Undo Log 활용
- 과정 : [MVCC_supplement](https://github.com/Pearl-K/database_study/blob/main/chapter5/source/MVCC_supplement.md#%EC%96%B8%EB%91%90-%EB%A1%9C%EA%B7%B8-undo-log-%ED%99%9C%EC%9A%A9)
- Undo Log 영역의 데이터는 COMMIT or ROLLBACK 을 호출하여 InnoDB 버퍼풀도 이전의 데이터로 복구되고, 더 이상 Undo 영역을 필요로 하는 트랜잭션이 없을 때 비로소 삭제된다.


### 2. Undo 로그
- Undo 로그는 트랜잭션이 데이터베이스 내에서 데이터를 변경할 때, 변경 이전의 상태를 저장하는 로그이다.
- 트랜잭션이 취소되거나 오류가 발생할 경우, Undo 로그를 활용하여 데이터를 원래 상태로 되돌릴 수 있다.
- 격리 수준과의 관계:
  - Read Uncommitted: 다른 트랜잭션이 커밋되지 않은 데이터를 읽을 수 있다. (버퍼 풀에서 읽는다)
  - Read Committed: 커밋된 데이터만 읽을 수 있다. Undo 로그를 사용하여 트랜잭션이 롤백될 경우 변경 전의 데이터를 복구한다.
  - Repeatable Read: 이 격리 수준에서는 트랜잭션이 시작된 시점의 데이터를 일관되게 보여줘야 한다. Undo 로그를 통해 트랜잭션 중에 변경된 데이터가 아니라 트랜잭션이 시작될 당시의 데이터를 제공한다.
  - Serializable: 가장 엄격한 격리 수준으로, Undo 로그는 트랜잭션이 중단되었을 때 데이터 일관성을 유지하는 데 사용된다.


### 3. Redo 로그
- Redo 로그는 트랜잭션이 커밋된 후 데이터를 영구적으로 기록하는 로그이다.
- 시스템 장애 발생 시, Redo 로그를 사용하여 최근 커밋된 트랜잭션의 데이터를 복구할 수 있다.
- 모든 격리 수준에서 중요한 역할을 하며, InnoDB의 데이터 일관성과 내구성을 유지하는 역할이다.



***

Ref.
- [Undo log](https://myinfrabox.tistory.com/262)
- [Redo log](https://myinfrabox.tistory.com/259)


